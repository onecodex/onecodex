name: test
on:
  push:
    branches:
      - master
  pull_request:

jobs:
  test-matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]  # , windows-latest]
        python-version: ['3.7', '3.8', '3.9', '3.10', '3.11']
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Display Python version
        run: python -c "import sys; print(sys.version)"
      - name: Install dependencies in a venv
        run: |
          # fix for installing scikit-bio==0.5.7 on python-3.7
          if [[ $(python3 --version 2>&1) == *"Python 3.7"* ]]; then
              echo "--- Manually installing build deps for scikit-bio==0.5.7 w/ Python 3.7"
              pip install 'cython==0.29.32' 'numpy>=1.9.2' 'setuptools' 'wheel'
              pip install --no-build-isolation scikit-bio==0.5.7
          fi
          python3 -m venv venv
          . venv/bin/activate
          pip install -q -U pip
          pip install --progress-bar=off .[all,reports,testing]
      - name: Run all tests
        run: |
          . venv/bin/activate
          make test

  test-python3-w-simple-json:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'
      - name: Install dependencies in a venv
        run: |
          python3 -m venv venv
          . venv/bin/activate
          pip install -q -U pip
          pip install --progress-bar=off simplejson
          pip install --progress-bar=off .[all,testing]
      - name: Run tests (w/ simplejson)
        run: |
          . venv/bin/activate
          make test

  test-python3-w-altair:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'
      - name: Set Up Node
        uses: actions/setup-node@v1
        with:
          node-version: '20.x'
      - name: Set Up vega CLI
        run: |
          npm install -g vega-lite vega-cli canvas
      - name: Install dependencies in a venv
        run: |
          python3 -m venv venv
          . venv/bin/activate
          pip install -q -U pip
          pip install --progress-bar=off .[all,testing,reports]
      - name: Run report tests
        run: |
          . venv/bin/activate
          PYDEVD_DISABLE_FILE_VALIDATION=1 py.test tests/test_reports.py -vv

      - uses: nowsprinting/diff-pdf-action@v1
        with:
          file1: tests/data/test-report-expected.pdf
          file2: test-report-generated.pdf
          options: --verbose --output-diff=test-report-diff.pdf

      - name: Upload Report PDFs
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: example reports
          path: test-report-*.pdf

  import-times:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'
      - name: Install dependencies in a venv
        run: |
          python3 -m venv venv
          . venv/bin/activate
          pip install -q -U pip
          pip install --progress-bar=off simplejson tuna
          pip install --progress-bar=off .[all,testing]
      - name: Test import speeds
        run: |
          . venv/bin/activate
          py.test -v tests/test_speed.py
          python -X importtime -c 'import onecodex; onecodex.cli.onecodex()' 2> import.log
          mkdir tuna && mkdir tuna/static
          tuna -o tuna/ import.log
      - name: Archive tuna videos
        uses: actions/upload-artifact@v1
        if: failure()
        with:
          name: tuna
          path: tuna/
